{"version":3,"sources":["../../../../build/babel/loader/get-config.ts"],"names":["getPlugins","loaderOptions","source","filename","hasReactRefresh","isServer","development","pagesDir","isPageFile","startsWith","applyCommonJsItem","indexOf","require","type","reactRefreshItem","skipEnvCheck","noAnonymousDefaultExportItem","pageConfigItem","disallowExportAllItem","transformDefineItem","resolve","nextSsgItem","filter","Boolean","getOverrides","overrides","commonJsItem","test","plugins","configs","Map","getConfig","inputSourceMap","target","presets","hasJsxRuntime","configKey","has","get","nextPresetItem","nextBabelPreset","options","babelrc","cloneInputAst","undefined","sourceMaps","sourceFileName","caller","name","supportsStaticESM","supportsDynamicImport","supportsTopLevelAwait","Object","defineProperty","enumerable","writable","value","reason","Error","emitWarning","loadedOptions","config","set"],"mappings":"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","sourcesContent":["import nextBabelPreset from '../preset'\nimport { createConfigItem, loadOptions } from 'next/dist/compiled/babel/core'\nimport loadConfig from 'next/dist/compiled/babel/core-lib-config'\n\nimport { NextBabelLoaderOptions, NextJsLoaderContext } from './types'\nimport { consumeIterator } from './util'\n\nfunction getPlugins(\n  loaderOptions: NextBabelLoaderOptions,\n  source: string,\n  filename: string\n) {\n  const { hasReactRefresh, isServer, development, pagesDir } = loaderOptions\n  const isPageFile = filename.startsWith(pagesDir)\n\n  const applyCommonJsItem =\n    source.indexOf('module.exports') === -1\n      ? null\n      : createConfigItem(require('../plugins/commonjs'), { type: 'plugin' })\n  const reactRefreshItem = hasReactRefresh\n    ? createConfigItem(\n        [require('react-refresh/babel'), { skipEnvCheck: true }],\n        { type: 'plugin' }\n      )\n    : null\n  const noAnonymousDefaultExportItem =\n    hasReactRefresh && !isServer\n      ? createConfigItem(\n          [require('../plugins/no-anonymous-default-export'), {}],\n          { type: 'plugin' }\n        )\n      : null\n  const pageConfigItem =\n    !isServer && isPageFile\n      ? createConfigItem([require('../plugins/next-page-config')], {\n          type: 'plugin',\n        })\n      : null\n  const disallowExportAllItem =\n    !isServer && isPageFile\n      ? createConfigItem(\n          [require('../plugins/next-page-disallow-re-export-all-exports')],\n          { type: 'plugin' }\n        )\n      : null\n  const transformDefineItem = createConfigItem(\n    [\n      require.resolve('next/dist/compiled/babel/plugin-transform-define'),\n      {\n        'process.env.NODE_ENV': development ? 'development' : 'production',\n        'typeof window': isServer ? 'undefined' : 'object',\n        'process.browser': isServer ? false : true,\n      },\n      'next-js-transform-define-instance',\n    ],\n    { type: 'plugin' }\n  )\n  const nextSsgItem =\n    !isServer && isPageFile\n      ? createConfigItem([require.resolve('../plugins/next-ssg-transform')], {\n          type: 'plugin',\n        })\n      : null\n\n  return [\n    noAnonymousDefaultExportItem,\n    reactRefreshItem,\n    pageConfigItem,\n    disallowExportAllItem,\n    applyCommonJsItem,\n    transformDefineItem,\n    nextSsgItem,\n  ].filter(Boolean)\n}\n\nfunction getOverrides(overrides = []) {\n  const commonJsItem = createConfigItem(\n    require('next/dist/compiled/babel/plugin-transform-modules-commonjs'),\n    { type: 'plugin' }\n  )\n\n  return [\n    ...overrides,\n    {\n      test: [\n        /next[\\\\/]dist[\\\\/]next-server[\\\\/]lib/,\n        /next[\\\\/]dist[\\\\/]client/,\n        /next[\\\\/]dist[\\\\/]pages/,\n      ],\n      plugins: [commonJsItem],\n    },\n  ]\n}\n\nconst configs = new Map()\nexport default function getConfig(\n  this: NextJsLoaderContext,\n  {\n    source,\n    loaderOptions,\n    inputSourceMap,\n    target,\n    filename,\n  }: {\n    source: string\n    loaderOptions: NextBabelLoaderOptions\n    inputSourceMap?: object | null\n    target: string\n    filename: string\n  }\n) {\n  const {\n    presets = [],\n    isServer,\n    pagesDir,\n    development,\n    hasReactRefresh,\n    hasJsxRuntime,\n  } = loaderOptions\n  const configKey = `${isServer ? 'server' : 'client'}:${filename}`\n\n  if (configs.has(configKey)) {\n    return configs.get(configKey)\n  }\n\n  const nextPresetItem = createConfigItem(nextBabelPreset, { type: 'preset' })\n\n  let options = {\n    babelrc: false,\n    cloneInputAst: false,\n    filename,\n    inputSourceMap: inputSourceMap || undefined,\n\n    // Set the default sourcemap behavior based on Webpack's mapping flag,\n    // but allow users to override if they want.\n    sourceMaps:\n      loaderOptions.sourceMaps === undefined\n        ? inputSourceMap\n        : loaderOptions.sourceMaps,\n\n    // Ensure that Webpack will get a full absolute path in the sourcemap\n    // so that it can properly map the module back to its internal cached\n    // modules.\n    sourceFileName: filename,\n\n    plugins: getPlugins(loaderOptions, source, filename),\n\n    presets: [...presets, nextPresetItem],\n\n    overrides: getOverrides(loaderOptions.overrides),\n\n    caller: {\n      name: 'next-babel-turbo-loader',\n      supportsStaticESM: true,\n      supportsDynamicImport: true,\n\n      // Provide plugins with insight into webpack target.\n      // https://github.com/babel/babel-loader/issues/787\n      target: target,\n\n      // Webpack 5 supports TLA behind a flag. We enable it by default\n      // for Babel, and then webpack will throw an error if the experimental\n      // flag isn't enabled.\n      supportsTopLevelAwait: true,\n\n      isServer,\n      pagesDir,\n      development,\n      hasReactRefresh,\n      hasJsxRuntime,\n\n      ...loaderOptions.caller,\n    },\n  } as any\n\n  Object.defineProperty(options.caller, 'onWarning', {\n    enumerable: false,\n    writable: false,\n    value: (reason: any) => {\n      if (!(reason instanceof Error)) {\n        reason = new Error(reason)\n      }\n      this.emitWarning(reason)\n    },\n  })\n\n  const loadedOptions = loadOptions(options)\n  const config = consumeIterator(loadConfig(loadedOptions))\n\n  configs.set(configKey, config)\n\n  return config\n}\n"]}